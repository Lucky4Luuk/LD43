pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
local x=0
local y=64
local f=false --if player is flipped
local terrain={}
local terrainflowers={}
local terrainh={}
local seed=69
local camx=0
local camy=0

function updatemap()
	h=48
	local cx=flr(camx/8)
	for i=1+cx,128+cx do
		local pd=terrain[max(i-1,1)]
		local d=terrain[i]
		local nd=terrain[min(i+1,16)]
		local n=1
		if d==0 and pd==0 then
			n=1
		elseif d==-1 and (pd==0 or pd==-1) then
			n=2
		elseif d==1 and (pd==0 or pd==1) then
			n=5
		end
		if d==-1 then
			h-=8
		end
		mset(i-1-cx,h/8-1,terrainflowers[i])
		mset(i-1-cx,h/8,n)
		for y=h/8+1,9 do
			mset(i-1,y,4)
		end
		h+=d*8
		if d==-1 then
			h+=8
		end
		h=min(h/8,16)*8
	end
end

function gen_terrain(seed)
	srand(seed)
	local d=0
	local h=48
	local ph=48
 for i=1,1024 do
		if d==0 then --going straight
			local r=flr(rnd(3))
			if r==2 then
				d=flr(rnd(3)-1) --either -1,0 or -1
			end
		elseif d==-1 then --going up
			local r=flr(rnd(3))
			if r==2 then
				d=0
			end
		elseif d==1 then --going down
			local r=flr(rnd(3))
			if r==2 then
				d=0
			end
		end
		h+=d*8
		if h/8<1 then
			d=0
			h+=8
		end
		if h/8>6 then
			d=0
			h-=8
		end
		terrain[i]=d
		for j=0,7 do
			ph+=d
			terrainh[i*8+j]=ph
		end
		if d==0 then
			if flr(rnd(4))==0 then
				--mset(i-1,h/8-1,3)
				terrainflowers[i]=3
			else
				--mset(i-1,h/8-1,6)
				terrainflowers[i]=6
			end
		end
		--line(i*8,h-d,i*8+8,h,7)
 end
 
	updatemap()
end

function _init()
	gen_terrain(seed)
end

function _update()
	if btn(0) then
		x-=1
		f=true
		--y+=terrain[max(min(flr(x/8+1.5),16),1)]*-1
	end
	if btn(1) then
		x+=1
		f=false
		--y+=terrain[max(min(flr(x/8+1.5),16),1)]
	end
	local y1=terrainh[flr(x+15)]+16
	local y2=terrainh[flr(x+8)]+16
	y=min(y1,y2)
	camx=max(0,x-64)
	camy=min(0,y-52)
end

function _draw()
	cls()
	--updatemap()
 map(0+flr(camx/8),0+flr(camy/8),0-((camx/8)%1)*8,24-((camy/8)%1)*8,17,16)
	--map(0,0,0-((camx/8)%1)*8,24,17,16)
	--sspr(40,0,16,16,x,y,16,16,f,false)
	sspr(56,0,8,8,x-camx,y-camy,8,8,f,false)
	print("!===debug===!",0,0,1)
	print("mem: "..tostr(stat(0)),0,6,1)
	print("cpu: "..tostr(stat(1)),0,12,1)
end
__gfx__
0000000033b33333000000030000000000000000300000000000000055555555ddddddddcccccccc000000000000000000000000000000000000000000000000
00000000332b32b3000000330000000000000000330000000000000055555555ddddddddcccccccc000000000000000000000000000000000000000000000000
00700700b242b52b000003330000000000000000b33000000000000055705705ddddddddcccccccc000000000000000000000000000000000000000000000000
00077000445444450000333b0000000000000000233300000000000055555555ddddddddcccccccc000000000000000000000000000000000000000000000000
00077000542242240003333400000000000000004b3330000000000051555515ddddddddcccccccc000000000000000000000000000000000000000000000000
00700700244522520033bb5209000090000000005b2b33000000000051155115ddddddddcccccccc000000000000000000000000000000000000000000000000
000000000222020203b32b4403008030000000002442b3300030003055111155ddddddddcccccccc000000000000000000000000000000000000000000000000
000000000022000033b4524203030030000000005454b3333030303055555555ddddddddcccccccc000000000000000000000000000000000000000000000000
3b44442202442333000000000000000000000000a00000000000001a55555555dddddddd00000000000000000000000000000000000000000000000000000000
b42252500222432b000000000000000000000000a00000000000001a55555555dddddddd00000000000000000000000000000000000000000000000000000000
2444220000245445000000000000000000000000a00000000000001a55555555dddddddd00000000000000000000000000000000000000000000000000000000
4242500000522544000000000000000000000000a00000000000001a55555555dddddddd00000000000000000000000000000000000000000000000000000000
4522200000000222000000000000000000000000a00000000000001a55555555dddddddd00000000000000000000000000000000000000000000000000000000
2200000000000022000000000000000000000000a00000000000001a55555555dddddddd00000000000000000000000000000000000000000000000000000000
2000000000000000000000000000000000000000a00000000000001a55555555dddddddd00000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000aaaaaaaaaaaaaaaa55555555dddddddd00000000000000000000000000000000000000000000000000000000
