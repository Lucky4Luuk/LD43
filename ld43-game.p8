pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
local x=0
local y=64
local f=false --if player is flipped
local terrain={}
local terrainh={}
local seed=69

local slopeat={}
for i=1,256 do
	slopeat[i] = rnd(2)-1
end

function sampleperlin(x)
	local lo = flr(x)
	local hi = lo+1
	local dist = x-lo
	local loslope = slopeat[lo]
	local hislope = slopeat[hi]
	local lopos = loslope*dist
	local hipos = -hislope*(1-dist)
	local u = dist*dist*(3-2*dist)
	return (lopos*(1-u)) + (hipos*u)
end

function gen_terrain(seed)
	srand(seed)
	local d=0
	local h=48
	local ph=48
 for i=1,1024 do
		if d==0 then --going straight
			local r=flr(rnd(3))
			if r==2 then
				d=flr(rnd(3)-1) --either -1,0 or -1
			end
		elseif d==-1 then --going up
			local r=flr(rnd(3))
			if r==2 then
				d=0
			end
		elseif d==1 then --going down
			local r=flr(rnd(3))
			if r==2 then
				d=0
			end
		end
		h+=d*8
		if h/8<1 then
			d=0
			h+=8
		end
		if h/8>6 then
			d=0
			h-=8
		end
		terrain[i]=d
		for j=0,7 do
			ph+=d
			terrainh[i*8+j]=ph
			if d==1 then
				
			end
		end
		--line(i*8,h-d,i*8+8,h,7)
 end
 
	h=48
	for i=1,16 do
		local pd=terrain[max(i-1,1)]
		local d=terrain[i]
		local nd=terrain[min(i+1,16)]
		local n=1
		if d==0 and pd==0 then
			n=1
		elseif d==-1 and (pd==0 or pd==-1) then
			n=2
		elseif d==1 and (pd==0 or pd==1) then
			n=5
		end
		if d==-1 and nd==0 and pd==-1 then
			n=3
		end
		if d==-1 then
			h-=8
		end
		if d==0 then
			if flr(rnd(6))==0 then
				mset(i-1,h/8-1,3)
			else
				mset(i-1,h/8-1,6)
			end
		end
		mset(i-1,h/8,n)
		for y=h/8+1,9 do
			mset(i-1,y,4)
		end
		h+=d*8
		if d==-1 then
			h+=8
		end
		
		h=min(h/8,16)*8
	end
end

function _init()
	gen_terrain(seed)
end

function _update()
	if btn(0) then
		x-=1
		f=true
		--y+=terrain[max(min(flr(x/8+1.5),16),1)]*-1
	end
	if btn(1) then
		x+=1
		f=false
		--y+=terrain[max(min(flr(x/8+1.5),16),1)]
	end
	y=terrainh[flr(x+15)]+16
end

function _draw()
	cls()
 map(0,5,0,64,16,16)
	--sspr(40,0,16,16,x,y,16,16,f,false)
	sspr(56,0,8,8,x,y,8,8,f,false)
	print("!===debug===!",0,0,1)
	print("mem: "..tostr(stat(0)),0,6,1)
	print("cpu: "..tostr(stat(1)),0,12,1)
end
__gfx__
0000000033333333000000000000000055555555000000000000000055555555dddddddd00000000000000000000000000000000000000000000000000000000
0000000033533533000000030000000055555555300000000000000055555555dddddddd00000000000000000000000000000000000000000000000000000000
0070070035553553000000330000000055555555330000000000000055155155dddddddd00000000000000000000000000000000000000000000000000000000
0007700055553555000003330000000055555555333000000000000055555555dddddddd00000000000000000000000000000000000000000000000000000000
0007700055555555000333350000000055555555533330000000000051555515dddddddd00000000000000000000000000000000000000000000000000000000
0070070055555555003335350900009055555555535333000000000051155115dddddddd00000000000000000000000000000000000000000000000000000000
0000000055555555033355550300803055555555555353300030003055111155dddddddd00000000000000000000000000000000000000000000000000000000
0000000055555555335355550303003055555555555555333030303055555555dddddddd00000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000a00000000000001a55555555dddddddd00000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000a00000000000001a55555555dddddddd00000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000a00000000000001a55555555dddddddd00000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000a00000000000001a55555555dddddddd00000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000a00000000000001a55555555dddddddd00000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000a00000000000001a55555555dddddddd00000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000a00000000000001a55555555dddddddd00000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000aaaaaaaaaaaaaaaa55555555dddddddd00000000000000000000000000000000000000000000000000000000
